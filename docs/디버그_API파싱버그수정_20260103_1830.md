# API 응답 형식 파싱 버그 수정 및 지원 버전 확장

> wldeh/bible-api 응답 형식 파싱 오류 수정 및 지원 버전 11개로 확장

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 디버그_API파싱버그수정_20260103_1830.md |
| 카테고리 | 디버그 |
| 생성일시 | 2026-01-03 18:30 KST |
| 작성자 | Claude |
| 버전 | v1.0.0 |
| 위치 | `C:/claude/claudeproject/bibleapp/docs/디버그_API파싱버그수정_20260103_1830.md` |

---

## 목차

1. [문제 상황](#1-문제-상황)
2. [원인 분석](#2-원인-분석)
3. [해결 방법](#3-해결-방법)
4. [추가 작업: 지원 버전 확장](#4-추가-작업-지원-버전-확장)
5. [수정된 파일](#5-수정된-파일)

---

## 1. 문제 상황

### 증상
- 성경 버전 다운로드 시 "Fail" 오류 발생
- 다운로드 버튼 클릭 후 오류 메시지 표시

### 발생 환경
- Android 에뮬레이터 (Pixel_6)
- 성경 버전: KJV, ASV, WEB 등 다운로드 시도 시

---

## 2. 원인 분석

### API 응답 형식 불일치

**예상한 형식**:
```json
{
  "verses": [
    { "verse": 1, "text": "..." }
  ]
}
```

**실제 wldeh/bible-api 형식**:
```json
{
  "data": [
    { "book": "Genesis", "chapter": "1", "verse": "1", "text": "..." }
  ]
}
```

### 코드 분석
- `bibleApiService.ts`의 `transformBookData` 및 `transformChapterData` 메서드
- `apiData.verses`로 접근 시도 → `undefined` 반환 → 파싱 실패

---

## 3. 해결 방법

### 수정 내용

**파일**: `src/services/bibleApiService.ts`

**Before**:
```typescript
private transformBookData(bookId: number, bookName: string, apiData: any): BookData {
  const chapters = apiData.chapters || [];
  // ... (잘못된 형식 기대)
}
```

**After**:
```typescript
private transformBookData(bookId: number, bookName: string, apiData: any): BookData {
  const chapters: ChapterData[] = [];
  const chapterMap: Map<number, Array<{ verse: number; text: string }>> = new Map();

  // data 배열에서 장별로 그룹화
  const dataArray = apiData.data || apiData || [];
  for (const item of dataArray) {
    const chapterNum = parseInt(item.chapter, 10);
    const verseNum = parseInt(item.verse, 10);

    if (!chapterMap.has(chapterNum)) {
      chapterMap.set(chapterNum, []);
    }

    chapterMap.get(chapterNum)!.push({
      verse: verseNum,
      text: item.text,
    });
  }

  // Map을 ChapterData 배열로 변환
  const sortedChapters = Array.from(chapterMap.keys()).sort((a, b) => a - b);
  for (const chapterNum of sortedChapters) {
    const verses = chapterMap.get(chapterNum)!;
    // 절 번호로 정렬하고 중복 제거
    const uniqueVerses = verses
      .sort((a, b) => a.verse - b.verse)
      .filter((v, i, arr) => i === 0 || v.verse !== arr[i - 1].verse);

    chapters.push({
      bookId,
      chapter: chapterNum,
      verses: uniqueVerses,
    });
  }

  return {
    bookId,
    bookName: dataArray[0]?.book || bookName,
    chapters,
  };
}
```

---

## 4. 추가 작업: 지원 버전 확장

### API 버전 가용성 조사

wldeh/bible-api GitHub 저장소를 조사하여 실제 사용 가능한 버전 확인:

| 버전 | API ID | 상태 |
|------|--------|------|
| 일본어 (JPN) | ja-kougo | ❌ 미지원 |
| 한국어 추가 버전 | - | ❌ 저작권 문제로 미지원 |
| NIV | - | ❌ 저작권 문제로 미지원 |

### 새로 추가된 버전 (공개 도메인)

| 버전 ID | 이름 | 언어 | API ID |
|---------|------|------|--------|
| BSB | Berean Standard Bible | English | en-bsb |
| LSV | Literal Standard Version | English | en-lsv |
| DRA | Douay-Rheims American | English | en-dra |
| GNV | Geneva Bible | English | en-gnv |
| RV09 | Reina Valera 1909 | Español | es-rv09 |
| LUTH | Luther Bible 1912 | Deutsch | de-luther1912 |
| CUV | 和合本 (Chinese Union) | 中文 | cmn-Hans-CN-feb |

### 저작권 문제로 지원 불가

다음 버전들은 저작권으로 인해 무료 API에서 제공되지 않음:
- **NIV** (New International Version)
- **현대인의 성경**
- **메시지성경**
- **개역개정**

---

## 5. 수정된 파일

| 파일 | 변경 내용 |
|------|----------|
| `src/services/bibleApiService.ts` | transformBookData, transformChapterData 메서드 수정, VERSION_API_MAP 확장 |
| `src/data/versions/available.json` | 11개 버전, 5개 언어로 확장 |
| `docs/신규생성_다중성경버전지원_20260103_1700.md` | v1.1.0으로 업데이트 |
| `docs/bibleapp_WBS.md` | v2.3.0으로 업데이트, 8.19-8.20 작업 추가 |

---

## 관련 문서

- 신규생성_다중성경버전지원_20260103_1700.md - 다중 성경 버전 지원 기능
- bibleapp_WBS.md - 작업 진행 관리
