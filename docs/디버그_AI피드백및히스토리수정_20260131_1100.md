# AI 묵상 피드백 + 구절 히스토리 버그 수정

> 스마트폰 테스트에서 발견된 AI 묵상 피드백 무반응 및 구절 히스토리 미표시 버그 수정

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 디버그_AI피드백및히스토리수정_20260131_1100.md |
| 카테고리 | 디버그 |
| 생성일시 | 2026-01-31 11:00 KST |
| 작성자 | Claude Code |
| 관련 단계 | 19단계 (AI 분석 결과 영구 저장) |

---

## 1. 발견된 버그 (스마트폰 테스트)

| # | 증상 | 심각도 |
|---|------|--------|
| 1 | AI 묵상 피드백 "묵상 피드백 받기" 버튼 클릭 시 아무 반응 없음 | 높음 |
| 2 | 범위 구절(1:2-3) 묵상 시 피드백 API에 첫 구절 텍스트만 전달 | 보통 |
| 3 | "이 구절의 묵상 히스토리 보기" 클릭 시 항상 이력 없음 표시 | 높음 |

---

## 2. 원인 분석

### 버그 1: AI 묵상 피드백 무반응

**파일**: `src/screens/memo/MemoDetailScreen.tsx:139-140`

```typescript
// 기존 코드 (버그)
const runFeedback = useCallback(async () => {
    if (!memo || !verse) return;      // ← verse가 null이면 조용히 return
    setIsFeedbackLoading(true);       // ← 이 줄까지 도달하지 못함
```

**원인**: `bibleService.getVerse()`가 현재 선택된 `bibleVersion`으로 조회하는데, 다운로드하지 않은 외국어 버전이 선택되면 `verse`가 null. 로딩 표시도, 에러 메시지도 없이 함수가 종료됨.

**비교**: `/api/sentiment/hybrid` (감정분석)는 `memo.content`만 사용하여 `verse` 불필요 → 정상 동작. `/api/meditation/feedback` (묵상 피드백)는 `verse.text` 필요 → `verse` null 시 실패.

### 버그 2: 범위 구절 텍스트 누락

**파일**: `src/screens/memo/MemoDetailScreen.tsx:73-79`

```typescript
// 기존 코드 (버그)
const verseData = await bibleService.getVerse(
  bibleVersion, memoData.book_id, memoData.chapter, memoData.verse_num
);
// verse_num = verse_start → 첫 번째 절만 로드
```

**원인**: 야고보서 1:2-3 범위 묵상이면 `verse_num = 2`로 저장되어 2절 텍스트만 로드. 3절 텍스트 누락. Choco UI(`index.html`)에서는 `bible_text` 필드에 전체 구절 텍스트를 직접 입력하므로 정상 동작.

**API 파라미터 비교**:

| 파라미터 | Choco UI (정상) | 앱 (버그) |
|----------|----------------|-----------|
| `bible_ref` | "야고보서 1:2-3" | "야고보서 1:2-3" (정상) |
| `bible_text` | 2절+3절 전체 텍스트 | **2절 텍스트만** |
| `meditation_text` | 묵상 내용 | 묵상 내용 (정상) |

### 버그 3: 구절 히스토리 항상 빈 결과

**파일**: `src/services/memoService.ts:224`

```typescript
// 기존 코드 (버그)
const memos = await getMemosByVerse('KRV', parsedBookId, parsedChapter, parsedVerseNum);
//                                  ^^^^
//                                  'KRV' 하드코딩
```

**원인**: 메모 생성 시 `bible_id`는 현재 선택된 성경 버전(예: `korHKJV`)으로 저장됨. 히스토리 조회는 항상 `'KRV'`로 검색하므로 버전이 다르면 결과 0건.

DB 쿼리 (`memoQueries.ts:220-226`):
```sql
WHERE m.bible_id = ? AND m.book_id = ? AND m.chapter = ? AND m.verse_num = ?
-- bible_id = 'KRV' 고정 → 'korHKJV'로 저장된 메모는 검색 안됨
```

---

## 3. 수정 내용

### 수정 1: 범위 구절 전체 텍스트 로드 + verse null 에러 처리

**파일**: `src/screens/memo/MemoDetailScreen.tsx`

```typescript
// 신규 state 추가
const [fullVerseText, setFullVerseText] = useState<string>('');

// loadData()에서 범위 구절 전체 텍스트 합침
if (memoData.verse_range && memoData.verse_start && memoData.verse_end) {
  const verseTexts: string[] = [];
  for (let vn = memoData.verse_start; vn <= memoData.verse_end; vn++) {
    const v = await bibleService.getVerse(bibleVersion, memoData.book_id, memoData.chapter, vn);
    if (v) verseTexts.push(v.text);
  }
  setFullVerseText(verseTexts.join(' '));
} else if (verseData) {
  setFullVerseText(verseData.text);
}

// runFeedback(): verse null guard 제거, fullVerseText 사용
const runFeedback = useCallback(async () => {
  if (!memo) return;
  setIsFeedbackLoading(true);           // ← 항상 로딩 표시
  setFeedbackError(null);
  try {
    const bibleText = fullVerseText || verse?.text || '';
    if (!bibleText) {
      setFeedbackError('성경 본문을 불러올 수 없습니다. 성경 버전을 확인해주세요.');
      return;                            // ← 에러 메시지 표시 후 return
    }
    const result = await chocoService.forceMeditationFeedback({
      bible_text: bibleText,             // ← 범위 전체 텍스트
      bible_ref: getVerseRangeDisplay(),
      meditation_text: memo.content,
    });
    // ... 결과 처리 ...
  } finally {
    setIsFeedbackLoading(false);
  }
}, [memo, verse, fullVerseText, bookName]);
```

### 수정 2: 구절 히스토리 bible_id 하드코딩 제거

**파일**: `src/screens/memo/VerseHistoryScreen.tsx:82-84`

```typescript
// Before (버그): bible_id = 'KRV' 고정
const verseMemos = await memoService.getMemosByVerse(verseId);

// After (수정): bible_id 무관, 모든 버전 검색
const verseMemos = await memoService.getMemosByVerseLocation(
  parsed.bookId, parsed.chapter, parsed.verseNum
);
```

`getMemosByVerseLocation()` SQL:
```sql
WHERE m.book_id = ? AND m.chapter = ? AND m.verse_num = ? AND m.is_deleted = 0
-- bible_id 조건 없음 → 모든 성경 버전의 메모 검색
```

---

## 4. 변경 파일 요약

| # | 파일 | 변경 내용 |
|---|------|----------|
| 1 | `src/screens/memo/MemoDetailScreen.tsx` | `fullVerseText` state 추가, 범위 구절 전체 텍스트 로드, `runFeedback` verse null 에러 처리 |
| 2 | `src/screens/memo/VerseHistoryScreen.tsx` | `getMemosByVerse` → `getMemosByVerseLocation` 변경 |

---

## 5. 빌드 정보

- **커밋**: `6e6e787` - fix: AI 묵상 피드백 + 구절 히스토리 버그 수정
- **EAS Build**: https://expo.dev/accounts/chohk9147/projects/bible-app/builds/d44fc133-33ca-4f1e-824d-91b11db37585
- **TypeScript**: 신규 에러 없음
