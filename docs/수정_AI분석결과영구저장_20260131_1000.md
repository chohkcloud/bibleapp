# AI 분석 결과 영구 저장 + 히스토리 관리

> 19단계: AI 감정분석/묵상 피드백 결과 DB 영구 저장 및 히스토리 관리 기능

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 수정_AI분석결과영구저장_20260131_1000.md |
| 카테고리 | 수정 |
| 생성일시 | 2026-01-31 10:00 KST |
| 작성자 | Claude Code |
| 관련 단계 | 19단계 |

---

## 1. 배경

### 기존 문제
- AI 감정분석 결과가 DB에 저장되지 않아 메모를 열 때마다 API를 재호출
- 매번 다른 분석 결과가 표시되어 일관성 없음
- AI 묵상 피드백 (`/api/meditation/feedback`) 기능이 구현되어 있으나 동작하지 않음
- 구절 히스토리 (`VerseHistoryScreen`) verseId 포맷 불일치로 동작 안함
- 메모 저장 후 `goBack()`으로 이전 화면으로 돌아가 QT 목록이 아닌 곳으로 이동

### 해결 방향
1. AI 감정분석/묵상 피드백 결과를 DB에 영구 저장
2. 저장된 결과를 메모 열 때 바로 표시 (API 재호출 없음)
3. 재분석 시 경고 후 진행, 이전 결과는 히스토리로 보관
4. 구절 히스토리 verseId 포맷 수정
5. 메모 탭 이름 "메모" → "QT" 변경
6. 메모 저장 후 MemoList로 이동

---

## 2. 변경 파일 목록

| # | 파일 | 변경 유형 | 설명 |
|---|------|----------|------|
| 1 | `src/types/database.ts` | 수정 | Memo 인터페이스에 feedback_data 필드 추가 |
| 2 | `src/services/database/index.ts` | 수정 | feedback_data 컬럼 마이그레이션 + ai_analysis_history 테이블 생성 |
| 3 | `src/services/database/memoQueries.ts` | 수정 | AI 데이터 CRUD 쿼리 함수 4개 추가 |
| 4 | `src/services/memoService.ts` | 수정 | 분석 결과 저장/조회 서비스 함수 추가, triggerEmotionAnalysis 개선 |
| 5 | `src/screens/memo/MemoEditScreen.tsx` | 수정 | 저장 시 emotion_data 함께 저장, MemoList로 이동 |
| 6 | `src/screens/memo/MemoDetailScreen.tsx` | 대폭 수정 | 저장된 분석 결과 표시, 재분석/피드백, 히스토리 UI |
| 7 | `src/navigation/MainTabs.tsx` | 수정 | 탭 이름 "메모" → "QT" 변경 |

---

## 3. 상세 변경 내용

### 3.1 DB 스키마 변경 (`database/index.ts`)

```sql
-- feedback_data 컬럼 추가 (마이그레이션)
ALTER TABLE memos ADD COLUMN feedback_data TEXT;

-- 히스토리 테이블 생성
CREATE TABLE IF NOT EXISTS ai_analysis_history (
  history_id TEXT PRIMARY KEY,
  memo_id TEXT NOT NULL,
  analysis_type TEXT NOT NULL,  -- 'emotion' | 'feedback'
  result_data TEXT NOT NULL,    -- JSON string
  created_at TEXT NOT NULL,
  FOREIGN KEY (memo_id) REFERENCES memos(memo_id)
);

CREATE INDEX IF NOT EXISTS idx_ai_history_memo
  ON ai_analysis_history(memo_id, analysis_type);
```

### 3.2 Memo 타입 확장 (`database.ts`)

```typescript
export interface Memo {
  // ... 기존 필드 ...
  emotion_data?: string | null;    // AI 감정분석 결과 JSON (기존 컬럼, 미사용 → 활성화)
  feedback_data?: string | null;   // AI 묵상 피드백 결과 JSON (신규)
}
```

### 3.3 DB 쿼리 함수 (`memoQueries.ts`)

```typescript
// 감정분석 결과 저장
updateMemoEmotionData(memoId: string, emotionDataJson: string): Promise<void>

// 묵상 피드백 결과 저장
updateMemoFeedbackData(memoId: string, feedbackDataJson: string): Promise<void>

// 히스토리 기록 추가
addAnalysisHistory(memoId: string, analysisType: string, resultDataJson: string): Promise<void>

// 히스토리 조회 (최신순)
getAnalysisHistory(memoId: string, analysisType: string): Promise<AnalysisHistory[]>
```

### 3.4 서비스 레이어 (`memoService.ts`)

```typescript
// 감정분석 결과 저장 + 히스토리 기록
saveEmotionData(memoId: string, resultJson: string): Promise<void>

// 묵상 피드백 결과 저장 + 히스토리 기록
saveFeedbackData(memoId: string, resultJson: string): Promise<void>

// 히스토리 조회
getAIAnalysisHistory(memoId: string, type: 'emotion' | 'feedback'): Promise<AnalysisHistory[]>

// triggerEmotionAnalysis 개선: memoId 파라미터 추가 → 결과 자동 DB 저장
triggerEmotionAnalysis(content: string, memoId?: string): void
```

### 3.5 MemoEditScreen 변경

- **저장 시 emotion_data 함께 저장**: `emotionResult`가 있으면 `memoService.saveEmotionData()` 호출
- **네비게이션 변경**: `navigation.goBack()` → `navigation.navigate('MemoList')`

### 3.6 MemoDetailScreen 변경 (핵심)

#### 감정분석 섹션
- `memo.emotion_data`가 있으면 파싱하여 바로 표시 (API 호출 안함)
- 없으면 "분석 시작하기" 버튼 표시
- 결과 있을 때 "재분석" 버튼 → Alert 경고 → 확인 시 API 호출 → DB 저장
- "이전 분석" 버튼 → 히스토리 오버레이 표시

#### 묵상 피드백 섹션
- `memo.feedback_data`가 있으면 파싱하여 바로 표시
- 없으면 "피드백 받기" 버튼 표시
- 결과 있을 때 "재요청" 버튼 → Alert 경고 → 확인 시 API 호출 → DB 저장
- "이전 피드백" 버튼 → 히스토리 오버레이 표시

#### 구절 히스토리 버그 수정
```typescript
// Before (버그): verse_id 숫자값 (예: 1001001)
verseId: String(verse.verse_id)

// After (수정): bookId_chapter_verseNum 형식 (예: 1_1_1)
verseId: `${memo.book_id}_${memo.chapter}_${memo.verse_num}`
```

### 3.7 MainTabs 탭 이름 변경

```typescript
// Before
options={{ tabBarLabel: '메모' }}

// After
options={{ tabBarLabel: 'QT' }}
```

---

## 4. 동작 흐름

### 메모 저장 시
1. 내용 암호화 → DB 저장
2. `emotionResult`가 있으면 → `emotion_data`에 JSON 저장 + 히스토리 기록
3. `navigation.navigate('MemoList')` → QT 목록으로 이동

### 메모 상세 열 때
1. memo 로드 → `emotion_data` 파싱 → 감정분석 결과 즉시 표시
2. `feedback_data` 파싱 → 묵상 피드백 결과 즉시 표시
3. API 호출 없음 (저장된 데이터 사용)

### 재분석/재피드백 요청 시
1. Alert("기존 분석 결과가 새 결과로 대체됩니다. 계속하시겠습니까?")
2. 확인 → API 호출 → 결과 DB 저장 + 히스토리 기록
3. UI 갱신

### 히스토리 보기
1. "이전 분석 보기" 버튼 탭
2. `ai_analysis_history` 테이블에서 해당 memo_id 기록 조회
3. 오버레이로 시간순 목록 표시

---

## 5. 사용 API

| API | 용도 | 엔드포인트 |
|-----|------|-----------|
| Hybrid Sentiment Analysis | AI 감정분석 (자동) | `POST /api/sentiment/hybrid` |
| Meditation Feedback | AI 묵상 피드백 (수동) | `POST /api/meditation/feedback` |

---

## 6. 빌드 정보

- **EAS Build**: https://expo.dev/accounts/chohk9147/projects/bible-app/builds/0d234610-532b-4bad-a152-d088d217720c
- **플랫폼**: Android (preview profile)
- **TypeScript 검증**: 신규 에러 없음 (기존 `db is possibly null` 에러만 존재)
