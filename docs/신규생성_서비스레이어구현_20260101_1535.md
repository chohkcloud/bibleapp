# 서비스 레이어 구현 완료 보고서

> 4단계 작업 완료 문서

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 신규생성_서비스레이어구현_20260101_1535.md |
| 카테고리 | 신규생성 |
| 생성일시 | 2026-01-01 15:35 KST |
| 작성자 | Claude |
| 버전 | v1.0.0 |

---

## 1. 작업 개요

| 항목 | 내용 |
|------|------|
| 작업 단계 | 4단계: 서비스 레이어 구현 |
| 참조 문서 | API.md |
| 작업 시작 | 20260101_1529 |
| 작업 완료 | 20260101_1535 |

---

## 2. 생성 파일 목록

### 2.1 유틸리티

| # | 파일 경로 | 설명 |
|---|----------|------|
| 1 | `src/utils/errorCodes.ts` | 에러 코드 및 AppError 클래스 |
| 2 | `src/utils/crypto.ts` | 암호화/복호화 유틸리티 |
| 3 | `src/utils/index.ts` | 유틸리티 통합 export |

### 2.2 서비스

| # | 파일 경로 | 설명 |
|---|----------|------|
| 1 | `src/services/authService.ts` | 인증 및 보안 서비스 |
| 2 | `src/services/bibleService.ts` | 성경 데이터 조회 서비스 |
| 3 | `src/services/memoService.ts` | 메모 CRUD 서비스 |
| 4 | `src/services/analyticsService.ts` | 통계 및 분석 서비스 |
| 5 | `src/services/shareService.ts` | 이미지 생성 및 공유 서비스 |

### 2.3 업데이트된 파일

| # | 파일 경로 | 설명 |
|---|----------|------|
| 1 | `src/services/index.ts` | 서비스 통합 export 업데이트 |

---

## 3. 구현 상세

### 3.1 errorCodes.ts

**에러 코드 카테고리:**
- `DB_XXX` - 데이터베이스 관련
- `AUTH_XXX` - 인증 관련
- `ENC_XXX` - 암호화 관련
- `SHARE_XXX` - 공유 관련
- `VAL_XXX` - 검증 관련
- `MEMO_XXX` - 메모 관련
- `BIBLE_XXX` - 성경 관련
- `GEN_XXX` - 일반

**주요 클래스:**
```typescript
class AppError extends Error {
  code: ErrorCode;
  originalError?: Error;
}
```

**헬퍼 함수:**
- `isAppError(error)` - AppError 여부 확인
- `wrapError(error, code?)` - 일반 에러를 AppError로 래핑

---

### 3.2 crypto.ts

**해시 함수:**
- `sha256(data)` - SHA-256 해시 생성
- `hashPassword(password, salt?)` - 비밀번호 해시 (1000회 반복)
- `verifyPassword(password, hash, salt)` - 비밀번호 검증

**암호화/복호화:**
- `encrypt(plainText, key)` - XOR 기반 암호화 (Base64 출력)
- `decrypt(encryptedText, key)` - 복호화

**키 생성:**
- `generateEncryptionKey()` - 256비트 암호화 키 생성
- `generateUUID()` - UUID v4 생성

---

### 3.3 AuthService

**비밀번호 관리:**
| 함수 | 설명 |
|------|------|
| `isPasswordSet()` | 비밀번호 설정 여부 확인 |
| `setPassword(password)` | 비밀번호 설정 |
| `verifyPassword(password)` | 비밀번호 검증 |
| `changePassword(oldPw, newPw)` | 비밀번호 변경 |

**생체인식:**
| 함수 | 설명 |
|------|------|
| `isBiometricAvailable()` | 생체인식 사용 가능 여부 |
| `getBiometricTypes()` | 지원 생체인식 타입 조회 |
| `isBiometricEnabled()` | 생체인식 활성화 여부 |
| `setBiometricEnabled(enabled)` | 생체인식 활성화/비활성화 |
| `authenticateWithBiometric()` | 생체인식 인증 |

**암호화 키:**
| 함수 | 설명 |
|------|------|
| `getEncryptionKey()` | 암호화 키 조회/생성 |
| `clearAllAuthData()` | 모든 인증 데이터 삭제 |

---

### 3.4 BibleService

**언어/버전:**
| 함수 | 설명 |
|------|------|
| `getLanguages()` | 지원 언어 목록 |
| `getBibles(langId?)` | 성경 버전 목록 |
| `getBibleById(bibleId)` | 특정 성경 버전 조회 |

**책/장/절:**
| 함수 | 설명 |
|------|------|
| `getBooks(langId)` | 책 목록 (이름 포함) |
| `getBooksByTestament(testament)` | 구약/신약별 책 목록 |
| `getChapter(bibleId, bookId, chapter)` | 장 구절 (메타 포함) |
| `getChapterSimple(...)` | 장 구절 (메타 없이) |
| `getVerse(bibleId, bookId, chapter, verseNum)` | 특정 구절 |
| `getVerseById(verseId)` | ID로 구절 조회 |

**검색:**
| 함수 | 설명 |
|------|------|
| `search(bibleId, query, langId, limit?)` | 전문 검색 (FTS5) |
| `searchSimple(...)` | 단순 검색 (LIKE) |

**네비게이션:**
| 함수 | 설명 |
|------|------|
| `getTotalChapters(bookId)` | 책의 총 장 수 |
| `getTotalVerses(...)` | 장의 총 절 수 |
| `getVerseReference(...)` | 구절 레퍼런스 문자열 |
| `getPreviousChapter(...)` | 이전 장 정보 |
| `getNextChapter(...)` | 다음 장 정보 |

---

### 3.5 MemoService

**메모 CRUD:**
| 함수 | 설명 |
|------|------|
| `createMemo(input)` | 메모 생성 (암호화) |
| `getMemo(memoId)` | 메모 조회 (복호화) |
| `getMemos(filter?, limit?, offset?)` | 메모 목록 (필터/복호화) |
| `getMemosByVerse(...)` | 구절별 메모 목록 |
| `updateMemo(memoId, input)` | 메모 수정 (암호화) |
| `deleteMemo(memoId)` | 메모 삭제 (Soft Delete) |
| `permanentDeleteMemo(memoId)` | 영구 삭제 |
| `restoreMemo(memoId)` | 삭제된 메모 복원 |

**태그:**
| 함수 | 설명 |
|------|------|
| `getTags()` | 태그 목록 |
| `createTag(name, color)` | 태그 생성 |
| `deleteTag(tagId)` | 태그 삭제 |
| `addTagToMemo(memoId, tagId)` | 메모에 태그 추가 |
| `removeTagFromMemo(memoId, tagId)` | 메모에서 태그 제거 |

**북마크:**
| 함수 | 설명 |
|------|------|
| `createBookmark(...)` | 북마크 생성 |
| `deleteBookmark(bookmarkId)` | 북마크 삭제 |
| `getAllBookmarks()` | 모든 북마크 |
| `isBookmarked(...)` | 북마크 여부 확인 |
| `toggleBookmark(...)` | 북마크 토글 |

**하이라이트:**
| 함수 | 설명 |
|------|------|
| `createHighlight(...)` | 하이라이트 생성 |
| `deleteHighlight(highlightId)` | 하이라이트 삭제 |
| `removeHighlightFromVerse(verseId)` | 구절 하이라이트 제거 |
| `getHighlightsByChapter(...)` | 장별 하이라이트 |

---

### 3.6 AnalyticsService

**요약 통계:**
| 함수 | 설명 |
|------|------|
| `getSummary()` | 전체 요약 (총메모, 주간/월간, 연속일수) |

**상세 통계:**
| 함수 | 설명 |
|------|------|
| `getTopVerses(langId, limit?)` | TOP N 자주 묵상한 구절 |
| `getDailyStats(days?)` | 일별 통계 (최근 N일) |
| `getMonthlyStats(months?)` | 월별 통계 (최근 N개월) |
| `getTagStats()` | 태그별 분포 |
| `getVerseHistory(...)` | 특정 구절 묵상 히스토리 |

**분석:**
| 함수 | 설명 |
|------|------|
| `calculateStreak()` | 연속 묵상 일수 계산 |
| `getMostActiveDay()` | 가장 활발한 요일 |
| `getDayOfWeekStats()` | 요일별 통계 |
| `getBookStats(langId)` | 책별 통계 |
| `getRecentActivity(limit?)` | 최근 활동 |

---

### 3.7 ShareService

**이미지:**
| 함수 | 설명 |
|------|------|
| `generateImage(viewRef)` | View 캡처하여 이미지 생성 |
| `shareImage(imageUri, target?)` | 이미지 공유 |
| `imageToBase64(imageUri)` | 이미지 Base64 변환 |

**텍스트:**
| 함수 | 설명 |
|------|------|
| `shareText(text)` | 텍스트 공유 |
| `createShareText(...)` | 공유용 텍스트 생성 |

**유틸리티:**
| 함수 | 설명 |
|------|------|
| `isAvailable()` | 공유 기능 사용 가능 여부 |
| `createShareCardData(...)` | 공유 카드 데이터 생성 |
| `cleanupTempFiles()` | 임시 파일 정리 |
| `getTemplateColor(template)` | 템플릿 색상 조회 |
| `getAvailableTemplates()` | 사용 가능한 템플릿 목록 |

**템플릿:**
- `default` - 기본 (#FFFFFF)
- `minimal` - 미니멀 (#F5F5F5)
- `classic` - 클래식 (#FEF3C7)
- `dark` - 다크 (#1F2937)

---

## 4. 서비스 통합 Export

**src/services/index.ts:**
```typescript
// Database
export { databaseService } from './database';
export * from './database/bibleQueries';
export * from './database/memoQueries';
export * from './database/settingsQueries';

// Services
export { authService } from './authService';
export { bibleService } from './bibleService';
export { memoService } from './memoService';
export { analyticsService } from './analyticsService';
export { shareService } from './shareService';
```

---

## 5. 특이사항

### 5.1 암호화 전략
- XOR 기반 암호화 (expo-crypto에서 AES 직접 지원 안하므로 대체)
- IV(Initialization Vector) 사용하여 동일 평문도 다른 암호문 생성
- 비밀번호는 1000회 반복 해시로 보안 강화

### 5.2 메모 암호화/복호화
- 메모 생성 시 자동 암호화
- 메모 조회 시 자동 복호화
- 암호화 키는 SecureStore에 안전하게 저장

### 5.3 서비스 계층 구조
```
Services Layer
├── authService     → SecureStore, LocalAuthentication
├── bibleService    → databaseService (Bible.db)
├── memoService     → databaseService (User.db) + authService (암호화)
├── analyticsService → databaseService (User.db + Bible.db)
└── shareService    → react-native-view-shot, expo-sharing
```

---

## 6. 다음 단계

| 항목 | 내용 |
|------|------|
| 다음 단계 | 5단계: 화면 컴포넌트 고도화 |
| 참조 문서 | SCREENS.md |
| 주요 작업 | 인증, 성경, 검색, 메모, 통계, 공유, 설정 화면 고도화 |
| 추가 작업 | 서비스 연동, 테마 전환 기능 완성 |

---

## 문서 변경 이력

| 날짜 | 버전 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 2026-01-01 15:35 | v1.0.0 | 최초 작성 | Claude |
