# 성경 버전 전환 시 성경 미표시 버그 수정

> 다른 성경 버전으로 전환하면 성경 본문이 전혀 표시되지 않는 버그 수정

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 디버그_성경버전전환미표시수정_20260129_2155.md |
| 카테고리 | 디버그 |
| 생성일시 | 2026-01-29 21:55 KST |
| 작성자 | Claude Code |
| 버전 | v1.0.0 |
| 위치 | C:/claude/claudeproject/bibleapp/docs/디버그_성경버전전환미표시수정_20260129_2155.md |

---

## 목차

1. [버그 개요](#1-버그-개요)
2. [원인 분석](#2-원인-분석)
3. [수정 내용](#3-수정-내용)
4. [수정 파일 목록](#4-수정-파일-목록)
5. [테스트 체크리스트](#5-테스트-체크리스트)

---

## 1. 버그 개요

| 항목 | 내용 |
|------|------|
| 증상 | 설정에서 성경 버전을 다른 버전(예: HKJ, NIV 등)으로 전환하면 성경 본문이 전혀 표시되지 않음 |
| 재현 방법 | 1. APK 설치 후 정상 동작 확인 (기본 KRV) → 2. 설정 > 성경 버전 변경 (예: HKJ 개역개정) → 3. 성경 읽기 화면 진입 → 본문 없음 |
| 영향 범위 | 기본 KRV 외 모든 번들 성경 버전 (HCV, HKJ, HML, HRV, HSN, KJV, NIV, ASV, NAS, JPM) |
| 심각도 | 🔴 긴급 (핵심 기능 동작 불가) |

---

## 2. 원인 분석

### 2.1 데이터 저장 구조

BibleApp은 성경 데이터를 **두 가지 방식**으로 관리합니다:

| 구분 | 저장 방식 | 서비스 | 데이터 소스 |
|------|----------|--------|------------|
| DB 버전 | SQLite 데이터베이스 | `bibleService` | `bible.db` |
| 번들 버전 | JSON 파일 (인메모리) | `bundledBibleService` | `src/data/versions/bundled/*.json` |

- **DB에는 초기 버전 KRV(개역한글)만 존재**
- 번들 버전(HCV, HKJ, HML 등 10종)은 JSON 파일로만 존재하며 `bundledBibleService`를 통해 접근

### 2.2 타입 차이

```typescript
// DB 버전 타입 (Verse)
interface Verse {
  verse_id: number;
  bible_id: string;
  book_id: number;
  chapter: number;
  verse_num: number;    // ← 필드명 다름
  text: string;
}

// 번들 버전 타입 (BundledVerse)
interface BundledVerse {
  bookId: number;       // ← book_id가 아닌 bookId
  chapter: number;
  verse: number;        // ← verse_num이 아닌 verse
  text: string;
}
```

### 2.3 버그 발생 지점

**파일**: `src/screens/bible/ReadingScreen.tsx` (line 117)

```typescript
// 버그 코드 - DB만 조회
const chapterVerses = await bibleService.getChapterSimple(bibleVersion, bookId, chapter);
```

**호출 체인**:
1. `ReadingScreen.loadData()` → `bibleService.getChapterSimple()`
2. → `bibleQueries.getChapterVerses()` → SQLite `SELECT * FROM verses WHERE bible_id = ?`
3. → 번들 버전은 DB에 없으므로 **빈 배열 반환**
4. → 화면에 구절이 표시되지 않음

### 2.4 정상 동작하는 코드 (참고)

`ParallelBibleModal.tsx`는 `bundledBibleService`를 직접 호출하여 번들 버전도 정상 표시됩니다:

```typescript
const verses = bundledBibleService.getChapterVerses(versionId, bookId, chapter);
```

---

## 3. 수정 내용

### 3.1 ReadingScreen.tsx - loadData 함수 수정

**수정 전:**
```typescript
// 구절 로드
const chapterVerses = await bibleService.getChapterSimple(bibleVersion, bookId, chapter);
```

**수정 후:**
```typescript
// 구절 로드 - 번들 버전과 DB 버전 분기
let chapterVerses: Verse[];
if (bundledBibleService.isBundled(bibleVersion)) {
  // 번들 버전: JSON에서 로드 후 Verse 타입으로 변환
  const bundledVerses = bundledBibleService.getChapterVerses(bibleVersion, bookId, chapter);
  chapterVerses = bundledVerses.map((bv) => ({
    verse_id: bv.bookId * 1000000 + bv.chapter * 1000 + bv.verse, // 고유 ID 생성
    bible_id: bibleVersion,
    book_id: bv.bookId,
    chapter: bv.chapter,
    verse_num: bv.verse,
    text: bv.text,
  }));
} else {
  // DB 버전: 기존 방식
  chapterVerses = await bibleService.getChapterSimple(bibleVersion, bookId, chapter);
}
```

### 3.2 수정 핵심 포인트

| # | 포인트 | 설명 |
|---|--------|------|
| 1 | 버전 분기 | `bundledBibleService.isBundled()`로 번들 여부 판별 |
| 2 | 타입 변환 | `BundledVerse` → `Verse` 필드명 매핑 (`verse` → `verse_num`, `bookId` → `book_id`) |
| 3 | 고유 ID 생성 | `verse_id = bookId * 1000000 + chapter * 1000 + verse` (하이라이트/북마크 매핑용) |
| 4 | 하위 호환 | 기존 DB 버전(KRV, 다운로드 버전)은 기존 로직 그대로 유지 |

### 3.3 verse_id 생성 규칙

번들 버전은 DB에 없으므로 `verse_id`가 없습니다. 고유 ID를 아래 공식으로 생성합니다:

```
verse_id = bookId * 1,000,000 + chapter * 1,000 + verse

예: 요한복음(43) 3장 16절
    → 43 * 1,000,000 + 3 * 1,000 + 16 = 43,003,016
```

이 ID는 하이라이트/북마크 매핑에 사용되며, DB 버전의 실제 verse_id와 충돌하지 않습니다.

---

## 4. 수정 파일 목록

| # | 파일 경로 | 변경 유형 | 변경량 | 설명 |
|---|----------|----------|--------|------|
| 1 | `src/screens/bible/ReadingScreen.tsx` | 수정 | +12줄 | loadData 함수에 번들/DB 분기 로직 추가 |

---

## 5. 테스트 체크리스트

### 번들 버전 전환 테스트

- [ ] 기본 KRV → HKJ(개역개정) 전환 후 성경 본문 표시 확인
- [ ] HKJ → HML(현대인의 성경) 전환 후 성경 본문 표시 확인
- [ ] HML → KJV(영어) 전환 후 성경 본문 표시 확인
- [ ] KJV → KRV(기본) 복귀 후 성경 본문 표시 확인
- [ ] 모든 번들 버전(HCV, HKJ, HML, HRV, HSN, KJV, NIV, ASV, NAS, JPM) 전환 테스트

### 기존 기능 호환 테스트

- [ ] KRV(DB 버전) 정상 동작 확인
- [ ] 구절 하이라이트 기능 동작 확인
- [ ] 북마크 기능 동작 확인
- [ ] 메모/묵상 기능 동작 확인
- [ ] 범위 선택 모드 동작 확인
- [ ] 주석(Commentary) 표시 확인
- [ ] 비교 성경(Parallel) 모달 동작 확인

---

## 관련 문서

- [신규생성_다중성경버전지원_20260103_1700.md](./신규생성_다중성경버전지원_20260103_1700.md) - 다중 성경 버전 지원 기능 원본
- [수정_화면기능개선_20260128_1000.md](./수정_화면기능개선_20260128_1000.md) - 19단계 화면 기능 고도화
- [BUG_LIST.md](./BUG_LIST.md) - 버그 추적 관리

---

## 문서 업데이트 이력

| 날짜 | 버전 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 2026-01-29 21:55 | v1.0.0 | 최초 문서 생성 | Claude Code |
