# 데이터베이스 테이블 누락 수정

> Android 에뮬레이터 쿼리 오류 해결을 위한 누락 테이블 추가

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 디버그_데이터베이스테이블누락수정_20260103_1210.md |
| 카테고리 | 디버그 |
| 생성일시 | 2026-01-03 12:10 KST |
| 작성자 | Claude Code |
| 버전 | v1.0.0 |
| 위치 | C:/claude/claudeproject/bibleapp/docs/디버그_데이터베이스테이블누락수정_20260103_1210.md |

---

## 1. 문제 상황

### 1.1 오류 메시지
Android 에뮬레이터에서 앱 실행 시 Metro 로그에 다음 오류 발생:

```
ERROR Error loading home data: [AppError: 통계 요약 조회에 실패했습니다.]
ERROR Error loading reading data: [AppError: 하이라이트 조회에 실패했습니다.]
```

### 1.2 발생 환경
| 항목 | 버전 |
|------|------|
| Expo SDK | ~54.0.30 |
| React Native | 0.81.5 |
| expo-sqlite | 신규 API |
| 에뮬레이터 | Pixel_6 (Android) |

---

## 2. 분석 내용

### 2.1 오류 원인 분석
- `analyticsService.getSummary()` 함수에서 통계 쿼리 실패
- `memoService.getHighlightsByChapter()` 함수에서 하이라이트 조회 실패
- 공통 원인: 데이터베이스 테이블 미생성

### 2.2 코드 검사 결과
`database/index.ts`의 `initUserDb()` 함수 분석:

#### 누락된 테이블
| 테이블명 | 용도 | 상태 |
|----------|------|------|
| highlights | 구절 하이라이트 저장 | **누락** |
| bookmarks | 북마크 저장 | **누락** |
| memo_tag_map | 메모-태그 매핑 | **누락** |

#### 기존 테이블
- memos - 정상
- memo_tags - 정상
- settings - 정상

---

## 3. 수정 내용

### 3.1 수정 파일
```
C:\claude\claudeproject\bibleapp\bible-app\src\services\database\index.ts
```

### 3.2 수정 코드

#### Before (누락된 테이블)
```typescript
private async initUserDb(): Promise<void> {
  if (isWeb) return;
  const SQLite = require('expo-sqlite');
  this.userDb = await SQLite.openDatabaseAsync('user.db');
  await this.userDb.execAsync(`
    CREATE TABLE IF NOT EXISTS memos (...);
    CREATE TABLE IF NOT EXISTS memo_tags (...);
    CREATE TABLE IF NOT EXISTS settings (...);
    CREATE INDEX IF NOT EXISTS idx_memos_verse ON memos(...);
  `);
}
```

#### After (테이블 추가)
```typescript
private async initUserDb(): Promise<void> {
  if (isWeb) return;
  const SQLite = require('expo-sqlite');
  this.userDb = await SQLite.openDatabaseAsync('user.db');
  await this.userDb.execAsync(`
    CREATE TABLE IF NOT EXISTS memos (
      memo_id TEXT PRIMARY KEY,
      verse_id INTEGER,
      bible_id TEXT,
      book_id INTEGER,
      chapter INTEGER,
      verse_num INTEGER,
      content TEXT,
      tags TEXT,
      is_encrypted INTEGER DEFAULT 1,
      created_at TEXT,
      updated_at TEXT,
      is_deleted INTEGER DEFAULT 0
    );
    CREATE TABLE IF NOT EXISTS memo_tags (
      tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
      tag_name TEXT UNIQUE,
      color TEXT DEFAULT '#3B82F6',
      created_at TEXT
    );
    CREATE TABLE IF NOT EXISTS memo_tag_map (
      memo_id TEXT NOT NULL,
      tag_id INTEGER NOT NULL,
      PRIMARY KEY (memo_id, tag_id)
    );
    CREATE TABLE IF NOT EXISTS bookmarks (
      bookmark_id TEXT PRIMARY KEY,
      verse_id INTEGER,
      bible_id TEXT,
      book_id INTEGER,
      chapter INTEGER,
      verse_num INTEGER,
      title TEXT,
      created_at TEXT
    );
    CREATE TABLE IF NOT EXISTS highlights (
      highlight_id TEXT PRIMARY KEY,
      verse_id INTEGER NOT NULL,
      bible_id TEXT,
      book_id INTEGER,
      chapter INTEGER,
      verse_num INTEGER,
      color TEXT DEFAULT '#FBBF24',
      created_at TEXT
    );
    CREATE TABLE IF NOT EXISTS settings (
      key TEXT PRIMARY KEY,
      value TEXT,
      updated_at TEXT
    );
    CREATE INDEX IF NOT EXISTS idx_memos_verse ON memos(book_id, chapter, verse_num);
    CREATE INDEX IF NOT EXISTS idx_bookmarks_verse ON bookmarks(book_id, chapter, verse_num);
    CREATE INDEX IF NOT EXISTS idx_highlights_chapter ON highlights(bible_id, book_id, chapter);
  `);
}
```

### 3.3 추가된 항목

| 항목 | 설명 |
|------|------|
| highlights 테이블 | 구절 하이라이트 데이터 저장 |
| bookmarks 테이블 | 북마크 데이터 저장 |
| memo_tag_map 테이블 | 메모-태그 다대다 관계 |
| idx_bookmarks_verse 인덱스 | 북마크 조회 최적화 |
| idx_highlights_chapter 인덱스 | 하이라이트 조회 최적화 |

---

## 4. 테스트 결과

### 4.1 테스트 환경
- Android 에뮬레이터: Pixel_6
- Metro Bundler: `npx expo start --android --clear`

### 4.2 테스트 로그

#### 수정 전
```
ERROR Error loading home data: [AppError: 통계 요약 조회에 실패했습니다.]
ERROR Error loading reading data: [AppError: 하이라이트 조회에 실패했습니다.]
```

#### 수정 후
```
LOG [DatabaseService] 초기화 완료
```

### 4.3 테스트 상태
- [x] Metro Bundler 시작 확인
- [x] 데이터베이스 초기화 성공
- [x] 쿼리 오류 해결 확인
- [x] 앱 정상 실행 확인

---

## 5. 관련 이슈

### 5.1 이전 수정 사항
- gap 스타일 호환성 수정 (8개 파일) - 별도 문서 참조

### 5.2 Render Error 관련
- "View config getter callback for component 'style'" 오류
- 데이터베이스 쿼리 오류와 연관성 확인 필요
- 추가 테스트 진행 중

---

## 6. 관련 문서

- [디버그_gap스타일호환성수정_20260103_1150.md](./디버그_gap스타일호환성수정_20260103_1150.md) - gap 스타일 수정
- [신규생성_안드로이드에뮬레이터실행_20260103_1034.md](./신규생성_안드로이드에뮬레이터실행_20260103_1034.md) - 8단계 작업
- [bibleapp_WBS.md](./bibleapp_WBS.md) - 작업 진척 관리

---

## 문서 업데이트 이력

| 날짜 | 버전 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 2026-01-03 12:10 | v1.0.0 | 최초 문서 생성 | Claude Code |
