# 백업 실패 수정 + 통계 UI 콤팩트 + 히스토리 뒤로가기

> 백업 기능 런타임 에러 수정 (expo-file-system v19 API 변경) + 통계 화면 콤팩트화 + 히스토리 뒤로가기 헤더

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 디버그_백업실패및통계UI및히스토리헤더_20260131_1600.md |
| 카테고리 | 디버그 |
| 생성일시 | 2026-01-31 16:00 KST |
| 작성자 | Claude Code |

---

## 1. 발견된 문제 (스마트폰 테스트)

| # | 증상 | 심각도 |
|---|------|--------|
| 1 | 설정 > 백업 > JSON 백업 생성 시 "백업 실패 - 백업 파일 생성 중 오류가 발생했습니다." 에러 | 높음 |
| 2 | 통계 화면(AnalyticsScreen) 상단 총묵상/연속일/이번주/이번달이 2x2 큰 카드로 표시 → 콤팩트 필요 | 낮음 |
| 3 | 묵상 히스토리(VerseHistoryScreen)에 뒤로가기 버튼 없음 → 화면에 갇힘 | 보통 |

---

## 2. 원인 분석

### 문제 1: 백업 실패 (근본 원인)

**파일**: `src/services/backupService.ts`

**근본 원인**: `expo-file-system` v19에서 레거시 API가 **런타임 에러를 발생**시킴.

```typescript
// 기존 코드 (v19에서 런타임 에러 발생)
const FileSystem = require('expo-file-system');
const filePath = `${FileSystem.cacheDirectory}${fileName}`;  // cacheDirectory = undefined
await FileSystem.writeAsStringAsync(filePath, jsonString, {   // "This method will throw in runtime"
  encoding: FileSystem.EncodingType.UTF8,
});
```

expo-file-system v19 변경사항:
- `cacheDirectory`, `documentDirectory` → `Paths.cache`, `Paths.document`로 변경
- `writeAsStringAsync()` → `file.write()`로 변경
- `readAsStringAsync()` → `file.text()`로 변경
- 레거시 API는 `legacyWarnings.d.ts`에서 "will throw in runtime"으로 표시

추가 문제:
- `feedback_data`, `bible_text` 컬럼이 백업/복원 데이터에 누락

### 문제 2: 통계 화면 UI

- 2x2 그리드 카드가 화면 상단을 많이 차지 → 아래 콘텐츠 접근성 저하

### 문제 3: 히스토리 뒤로가기

- `navigation` props는 있지만 뒤로가기 UI 컴포넌트가 없음

---

## 3. 수정 내용

### 수정 1: 백업 서비스 - expo-file-system v19 새 API 적용

**파일**: `src/services/backupService.ts`

#### Import 변경
```typescript
// Before (동적 require, 레거시 API)
const FileSystem = require('expo-file-system');
const Sharing = require('expo-sharing');

// After (정적 import, v19 새 API)
import { Paths, File } from 'expo-file-system';
import * as Sharing from 'expo-sharing';
```

#### 백업 파일 생성
```typescript
// Before (런타임 에러)
const filePath = `${FileSystem.cacheDirectory}${fileName}`;
await FileSystem.writeAsStringAsync(filePath, jsonString, { encoding: FileSystem.EncodingType.UTF8 });

// After (v19 새 API)
const backupFile = new File(Paths.cache, fileName);
backupFile.write(jsonString);
await Sharing.shareAsync(backupFile.uri, { ... });
```

#### 복원 파일 읽기
```typescript
// Before (런타임 에러)
const jsonString = await FileSystem.readAsStringAsync(fileUri, { encoding: FileSystem.EncodingType.UTF8 });

// After (v19 새 API)
const pickedFile = new File(fileUri);
const jsonString = await pickedFile.text();
```

#### 백업 데이터 확장
```typescript
// BackupMemo에 추가
feedback_data?: string | null;
bible_text?: string | null;

// 복원 INSERT에도 feedback_data, bible_text 포함
```

### 수정 2: 통계 화면 콤팩트 UI

**파일**: `src/screens/memo/AnalyticsScreen.tsx`

- 2x2 `summaryGrid` → 1줄 `compactStatsBar`로 변경
- 4개 항목(총묵상/연속일/이번주/이번달)을 구분선과 함께 한 줄 표시
- 폰트 크기: 32px → 20px / 라벨: 14px → 11px

### 수정 3: 묵상 히스토리 뒤로가기 헤더

**파일**: `src/screens/memo/VerseHistoryScreen.tsx`

- 상단에 뒤로가기 화살표 + "묵상 히스토리" 타이틀 헤더 추가
- `navigation.goBack()` 연결

---

## 4. 변경 파일 요약

| # | 파일 | 변경 내용 |
|---|------|----------|
| 1 | `src/services/backupService.ts` | expo-file-system v19 새 API 적용 + feedback_data/bible_text 백업 포함 |
| 2 | `src/screens/memo/AnalyticsScreen.tsx` | 상단 2x2 카드 → 한 줄 콤팩트 바 |
| 3 | `src/screens/memo/VerseHistoryScreen.tsx` | 뒤로가기 헤더 추가 |
| 4 | `docs/TODO.md` | TODO 3건 해결 완료 처리 |

---

## 5. 빌드 정보

- **TypeScript**: 신규 에러 없음
