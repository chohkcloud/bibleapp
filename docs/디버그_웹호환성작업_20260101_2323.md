# 웹 호환성 작업 (Web Compatibility)

> 네이티브 전용 모듈들의 웹 플랫폼 호환성 작업 기록

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 디버그_웹호환성작업_20260101_2323.md |
| 카테고리 | 디버그 |
| 생성일시 | 2026-01-01 23:23 KST |
| 작성자 | Claude Code |
| 버전 | v1.0.0 |
| 위치 | `C:/claude/claudeproject/bibleapp/docs/디버그_웹호환성작업_20260101_2323.md` |

---

## 1. 문제 상황

### 발생 에러
```
Uncaught SyntaxError: Cannot use 'import.meta' outside a module
```

### 원인
- Expo 네이티브 모듈들이 `import.meta`를 사용하며, 이는 웹 환경에서 지원되지 않음
- 정적 import 시 Metro 번들러가 웹에서도 네이티브 모듈을 로드하려고 시도

### 영향받은 모듈
| 모듈 | 용도 | 웹 지원 |
|------|------|---------|
| `expo-sqlite` | SQLite 데이터베이스 | ❌ |
| `expo-secure-store` | 보안 저장소 | ❌ |
| `expo-crypto` | 암호화 | ❌ |
| `expo-local-authentication` | 생체인식 | ❌ |
| `expo-sharing` | 공유 기능 | ❌ |
| `expo-file-system` | 파일 시스템 | ❌ |

---

## 2. 수정된 파일

### 2.1 src/services/database/index.ts

**변경 내용**: 웹 환경에서 목업 모드로 동작

```typescript
import { Platform } from 'react-native';

const isWeb = Platform.OS === 'web';

class DatabaseService {
  async initialize(): Promise<void> {
    if (isWeb) {
      console.log('[DatabaseService] 웹 환경 - 목업 모드');
      this.isInitialized = true;
      return;
    }
    // 네이티브 환경에서만 SQLite 초기화
    const SQLite = require('expo-sqlite');
    // ...
  }
}
```

### 2.2 src/utils/crypto.ts

**변경 내용**: Web Crypto API 사용

```typescript
const isWeb = Platform.OS === 'web';

async function generateRandomBytes(length: number): Promise<Uint8Array> {
  if (isWeb) {
    const array = new Uint8Array(length);
    if (typeof window !== 'undefined' && window.crypto?.getRandomValues) {
      window.crypto.getRandomValues(array);
    }
    return array;
  }
  const Crypto = require('expo-crypto');
  return await Crypto.getRandomBytesAsync(length);
}

export async function sha256(data: string): Promise<string> {
  if (isWeb && typeof window !== 'undefined' && window.crypto?.subtle) {
    const dataBuffer = new TextEncoder().encode(data);
    const hashBuffer = await window.crypto.subtle.digest('SHA-256', dataBuffer);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2, '0')).join('');
  }
  // 네이티브: expo-crypto 사용
  // ...
}
```

### 2.3 src/services/authService.ts

**변경 내용**: localStorage 폴백 사용

```typescript
const isWeb = Platform.OS === 'web';
const webStore: Record<string, string> = {};

async function getItem(key: string): Promise<string | null> {
  if (isWeb) {
    return webStore[key] || localStorage.getItem(key);
  }
  const SecureStore = require('expo-secure-store');
  return await SecureStore.getItemAsync(key);
}

async function setItem(key: string, value: string): Promise<void> {
  if (isWeb) {
    webStore[key] = value;
    localStorage.setItem(key, value);
    return;
  }
  const SecureStore = require('expo-secure-store');
  await SecureStore.setItemAsync(key, value);
}
```

### 2.4 src/services/shareService.ts

**변경 내용**: navigator.share API 사용

```typescript
const isWeb = Platform.OS === 'web';

class ShareService {
  async isAvailable(): Promise<boolean> {
    if (isWeb) { return Boolean(navigator.share); }
    const Sharing = require('expo-sharing');
    return await Sharing.isAvailableAsync();
  }

  async shareText(text: string): Promise<ShareResult> {
    if (isWeb && navigator.share) {
      try {
        await navigator.share({ text });
        return { success: true };
      } catch {
        return { success: false };
      }
    }
    // 네이티브: expo-sharing 사용
    // ...
  }
}
```

---

## 3. 핵심 패턴

### 플랫폼 감지
```typescript
import { Platform } from 'react-native';
const isWeb = Platform.OS === 'web';
```

### 동적 require (조건부 로딩)
```typescript
// 정적 import 대신 동적 require 사용
if (!isWeb) {
  const NativeModule = require('native-module');
  // 네이티브 전용 코드
}
```

### 웹 폴백
| 네이티브 모듈 | 웹 대체 |
|--------------|---------|
| expo-sqlite | 목업 모드 (데이터 없음) |
| expo-secure-store | localStorage |
| expo-crypto | Web Crypto API |
| expo-local-authentication | 미지원 (false 반환) |
| expo-sharing | navigator.share |

---

## 4. 작업 결과

### 완료된 작업
- [x] database/index.ts 웹 호환성 수정
- [x] crypto.ts 웹 호환성 수정
- [x] authService.ts 웹 호환성 수정
- [x] shareService.ts 웹 호환성 수정

### 현재 상태
- **상태**: ⚠️ 테스트 실패
- **원인**: 추가적인 네이티브 모듈 import가 다른 파일에 존재할 가능성
- **필요 작업**: 전체 코드베이스에서 네이티브 모듈 import 검색 및 수정

### 추가 확인 필요 파일
```bash
# 네이티브 모듈 import 검색
grep -r "from 'expo-" src/ --include="*.ts" --include="*.tsx"
```

---

## 5. 웹 개발 vs 앱 개발 전환 관련 의견

### 현재 프로젝트 상황
- Expo SDK 54 기반 React Native 프로젝트
- 네이티브 전용 기능 다수 사용 (SQLite, SecureStore, Biometric, etc.)
- 웹 호환성 레이어 필요

### 웹 먼저 개발의 장단점

| 장점 | 단점 |
|------|------|
| 빠른 개발 사이클 (HMR) | 네이티브 기능 테스트 불가 |
| 브라우저 DevTools 활용 | 목업 데이터로만 테스트 |
| 배포 없이 즉시 테스트 | 실제 동작과 차이 발생 가능 |
| 디버깅 용이 | 추가 호환성 코드 필요 |

### 권장 접근 방식

**하이브리드 개발 전략 권장**:

1. **UI/UX 프로토타이핑**: 웹에서 빠르게 개발
2. **비즈니스 로직 테스트**: 목업 데이터로 웹 테스트
3. **네이티브 기능 검증**: 실제 기기/에뮬레이터에서 테스트
4. **최종 통합**: 네이티브 환경에서 전체 테스트

---

## 6. 다음 작업

1. 전체 코드베이스에서 네이티브 모듈 검색
2. 추가 파일 웹 호환성 수정
3. bibleService.ts, memoService.ts 등 확인
4. 웹 환경 테스트 재시도

---

## 관련 문서

- [ARCHITECTURE.md](ARCHITECTURE.md) - 3-Layer 아키텍처
- [API.md](API.md) - 서비스 API 명세
- [bibleapp_WBS.md](bibleapp_WBS.md) - 작업 일정
