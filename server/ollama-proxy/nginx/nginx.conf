# Ollama Reverse Proxy Configuration
# Rate limiting, API Key validation, CORS support

# Rate limiting zone: 30 requests per minute per IP
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/m;

# Upstream Ollama server (Windows Docker Desktop)
upstream ollama {
    server host.docker.internal:11434;
    keepalive 32;
}

# Map for API key validation
# ${CHOCO_API_KEY} will be replaced by envsubst at container startup
map $http_x_api_key $api_key_valid {
    default 0;
    "${CHOCO_API_KEY}" 1;
}

# Log format with API key masking
log_format api_log '$remote_addr - [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   'api_key_valid:$api_key_valid '
                   'response_time:${upstream_response_time}s';

server {
    listen 80;
    server_name _;

    # Access log with custom format
    access_log /var/log/nginx/access.log api_log;
    error_log /var/log/nginx/error.log warn;

    # Default content type for error responses
    default_type application/json;

    # Health check endpoint (no auth required)
    location = /health {
        access_log off;
        return 200 '{"status":"healthy","service":"ollama-proxy","timestamp":"$time_iso8601"}';
    }

    # Proxy status endpoint (no auth required)
    location = /status {
        access_log off;
        return 200 '{"ollama_upstream":"host.docker.internal:11434","rate_limit":"30/min"}';
    }

    # API endpoints with authentication
    location /api/generate {
        # CORS preflight
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type, X-API-Key';
            add_header 'Access-Control-Max-Age' '86400';
            add_header 'Content-Length' '0';
            return 204;
        }

        # Check API key
        if ($http_x_api_key = "") {
            return 401 '{"error":"Unauthorized","message":"Missing X-API-Key header"}';
        }

        if ($api_key_valid = 0) {
            return 401 '{"error":"Unauthorized","message":"Invalid API key"}';
        }

        # Rate limiting
        limit_req zone=api_limit burst=10 nodelay;
        limit_req_status 429;

        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, X-API-Key' always;

        # Proxy to Ollama
        proxy_pass http://ollama/api/generate;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";

        # Streaming support
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        chunked_transfer_encoding on;

        # Large prompt support
        client_max_body_size 10M;
    }

    location /api/chat {
        # CORS preflight
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type, X-API-Key';
            add_header 'Access-Control-Max-Age' '86400';
            add_header 'Content-Length' '0';
            return 204;
        }

        # Check API key
        if ($http_x_api_key = "") {
            return 401 '{"error":"Unauthorized","message":"Missing X-API-Key header"}';
        }

        if ($api_key_valid = 0) {
            return 401 '{"error":"Unauthorized","message":"Invalid API key"}';
        }

        # Rate limiting
        limit_req zone=api_limit burst=10 nodelay;
        limit_req_status 429;

        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, X-API-Key' always;

        # Proxy to Ollama
        proxy_pass http://ollama/api/chat;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";

        # Streaming support
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        chunked_transfer_encoding on;

        # Large prompt support
        client_max_body_size 10M;
    }

    # Block all other /api/* endpoints
    location /api/ {
        return 403 '{"error":"Forbidden","message":"Only /api/generate and /api/chat are allowed"}';
    }

    # Block all other requests
    location / {
        return 404 '{"error":"Not Found","message":"Use /api/generate or /api/chat endpoints"}';
    }

    # Custom error pages
    error_page 429 = @rate_limited;
    location @rate_limited {
        internal;
        return 429 '{"error":"Too Many Requests","message":"Rate limit exceeded. Maximum 30 requests per minute.","retry_after":60}';
    }
}
